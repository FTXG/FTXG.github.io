<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="js/jquery3.6.0.js" type="application/javascript"></script>
</head>
<body>
<input id="wsaddr" type="text"><br>
<input class="aa" type="button" value="建立连接"><br>
<div class="box"></div>
<input id="message" type="text" placeholder="在此输入消息"><br>
<input id="send" type="button" value="发送">
<input id="close" type="button" value="关闭">

<div id="output"></div>

<script>
    init()
    $(".aa").on("click", function () {
        addsocket();
    })
    $("#send").on("click", function () {
        doSend();
    })
    $("#close").on("click",function () {
        closesocket();
    })
    var output;
    var websocket;

    function init() {
        output = document.getElementById("output");
    }

    function addsocket() {
        var wsaddr = $("#wsaddr").val();
        if (wsaddr == '') {
            JsonsMessageBox($("#wsaddr"), "请填写Websocket测试地址");
            return false;
        }
        StartWebSocket(wsaddr);
    }

    function StartWebSocket(wsUri) {
        websocket = new WebSocket(wsUri);

        websocket.onopen = function (evt) {
            onOpen(evt)
        };
        websocket.onclose = function (evt) {
            onClose(evt)
        };
        websocket.onmessage = function (evt) {
            onMessage(evt)
        };
        websocket.onerror = function (evt) {
            onError(evt)
        };
    }

    function closesocket() {
        if (websocket) {
            websocket.close();
        } else {
            writeToScreen("<span style='color:red'>Websocket未连接，无需进行断开操作！</span>");
        }
    }

    function onOpen(evt) {
        writeToScreen("<span style='color:red'>匿名消息站连接成功，现在你可以发送信息进行测试了！</span>");
    }

    function onClose(evt) {
        writeToScreen("<span style='color:red'>Websocket连接已断开！</span>");
        websocket.close();
    }

    function onMessage(evt) {
        console.log(evt.data);
        writeToScreen('<span style="color:blue">好友发送消息&nbsp;' + formatDate(new Date()) + '</span><br/><span>' + evt.data + '</span>');
    }

    function onError(evt) {
        writeToScreen('<span style="color: red;">发生错误:</span> ' + evt.data);
    }

    function doSend() {
        var message = $("#message").val();
        if (message == '') {
            JsonsMessageBox($("#message"), "请先填写要测试发送的消息");
            $("#message").focus();
            return false;
        }
        if (typeof websocket === "undefined") {
            JsonsMessageBox($("#message"), "Websocket还没有连接或者连接失败，请进行检测");
            return false;
        }
        if (websocket.readyState == 3) {
            JsonsMessageBox($("#message"), "Websocket已经关闭，请重新连接");
            return false;
        }
        $("#message").val('');
        writeToScreen('<span style="color:green">你发送的信息&nbsp;' + formatDate(new Date()) + '</span><br/>' + message);
        websocket.send(message);
    }

    function writeToScreen(message) {
        var div = "<div>" + message + "</div>";
        var d = $("#output");
        var d = d[0];
        var doScroll = d.scrollTop == d.scrollHeight - d.clientHeight;
        $("#output").append(div);
        if (doScroll) {
            d.scrollTop = d.scrollHeight - d.clientHeight;
        }
    }

    function en(event) {
        var evt = evt ? evt : (window.event ? window.event : null);
        if (evt.keyCode == 13) {
            doSend()
        }
    }

    function formatDate(now) {
        var year = now.getFullYear();
        var month = now.getMonth() + 1;
        var date = now.getDate();
        var hour = now.getHours();
        var minute = now.getMinutes();
        var second = now.getSeconds();
        return year + "-" + (month = month < 10 ? ("0" + month) : month) + "-" + (date = date < 10 ? ("0" + date) : date) + " " + (hour = hour < 10 ? ("0" + hour) : hour) + ":" + (minute = minute < 10 ? ("0" + minute) : minute) + ":" + (second = second < 10 ? ("0" + second) : second);
    }
</script>
</body>
</html>